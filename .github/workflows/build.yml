name: Build Linux Binary

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-22.04-arm64, macos-latest, windows-latest]
        python-version: [3.12]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install kubernetes>=24.2.0 PyYAML>=6.0 pydantic>=2.0 pyinstaller
        pip list

    - name: Build binary with PyInstaller (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        ARCH="amd64"
        if [ "${{ matrix.os }}" = "ubuntu-22.04-arm64" ]; then
          ARCH="arm64"
        elif [ "${{ matrix.os }}" = "macos-latest" ] && [ "$(uname -m)" = "arm64" ]; then
          ARCH="arm64"
        fi
        
        if [ "${{ matrix.os }}" = "ubuntu-22.04" ] || [ "${{ matrix.os }}" = "ubuntu-22.04-arm64" ]; then
          pyinstaller --onefile --name=gpuctl-linux-$ARCH --hidden-import=yaml --hidden-import=PyYAML main.py
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          pyinstaller --onefile --name=gpuctl-macos-$ARCH --hidden-import=yaml --hidden-import=PyYAML main.py
        fi
    
    - name: Build binary with PyInstaller (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $ARCH = if ($env:RUNNER_ARCH -eq 'ARM64') { 'arm64' } else { 'amd64' }
        pyinstaller --onefile --name=gpuctl-windows-$ARCH.exe --hidden-import=yaml --hidden-import=PyYAML main.py

    - name: Verify binary (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        ARCH="amd64"
        if [ "${{ matrix.os }}" = "ubuntu-22.04-arm64" ]; then
          ARCH="arm64"
        elif [ "${{ matrix.os }}" = "macos-latest" ] && [ "$(uname -m)" = "arm64" ]; then
          ARCH="arm64"
        fi
        
        if [ "${{ matrix.os }}" = "ubuntu-22.04" ] || [ "${{ matrix.os }}" = "ubuntu-22.04-arm64" ]; then
          BINARY_NAME="gpuctl-linux-$ARCH"
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
          BINARY_NAME="gpuctl-macos-$ARCH"
        fi
        
        chmod +x dist/$BINARY_NAME
        ./dist/$BINARY_NAME --help
    
    - name: Verify binary (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $ARCH = if ($env:RUNNER_ARCH -eq 'ARM64') { 'arm64' } else { 'amd64' }
        $BINARY_NAME = "gpuctl-windows-$ARCH.exe"
        dist\$BINARY_NAME --help

    - name: Upload binary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os == 'ubuntu-22.04' && 'gpuctl-linux-amd64' || matrix.os == 'ubuntu-22.04-arm64' && 'gpuctl-linux-arm64' || matrix.os == 'macos-latest' && 'gpuctl-macos-amd64' || matrix.os == 'windows-latest' && 'gpuctl-windows-amd64' }}
        path: ${{ matrix.os == 'ubuntu-22.04' && 'dist/gpuctl-linux-amd64' || matrix.os == 'ubuntu-22.04-arm64' && 'dist/gpuctl-linux-arm64' || matrix.os == 'macos-latest' && 'dist/gpuctl-macos-amd64' || matrix.os == 'windows-latest' && 'dist/gpuctl-windows-amd64.exe' }}

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./dist
    
    - name: List downloaded files
      run: |
        ls -la ./dist
        find ./dist -type f
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./dist/gpuctl-linux-amd64/gpuctl-linux-amd64
          ./dist/gpuctl-linux-arm64/gpuctl-linux-arm64
          ./dist/gpuctl-macos-amd64/gpuctl-macos-amd64
          ./dist/gpuctl-windows-amd64/gpuctl-windows-amd64.exe
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        body: |
          ## üöÄ gpuctl ${{ github.ref_name }} ÂèëÂ∏É
          
          ### ÂèØÊâßË°åÊñá‰ª∂
          - [gpuctl-linux-amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-linux-amd64) - Linux x86_64 ‰∫åËøõÂà∂ÂåÖ
          - [gpuctl-linux-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-linux-arm64) - Linux ARM64 ‰∫åËøõÂà∂ÂåÖ
          - [gpuctl-macos-amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-macos-amd64) - macOS x86_64 ‰∫åËøõÂà∂ÂåÖ
          - [gpuctl-macos-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-macos-arm64) - macOS ARM64 ‰∫åËøõÂà∂ÂåÖ
          - [gpuctl-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-windows-amd64.exe) - Windows x86_64 ‰∫åËøõÂà∂ÂåÖ
          - [gpuctl-windows-arm64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-windows-arm64.exe) - Windows ARM64 ‰∫åËøõÂà∂ÂåÖ
          
          ### ‰ΩøÁî®ÊñπÂºè
          ```bash
          # Linux/macOS x86_64Êû∂ÊûÑ
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-linux-amd64 -O gpuctl
          # Êàñ
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-macos-amd64 -o gpuctl
          
          # Linux/macOS ARM64Êû∂ÊûÑ
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-linux-arm64 -O gpuctl
          # Êàñ
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-macos-arm64 -o gpuctl
          
          chmod +x gpuctl
          sudo mv gpuctl /usr/local/bin/
          gpuctl --help
          ```
          
          ```powershell
          # Windows x86_64Êû∂ÊûÑ
          Invoke-WebRequest -Uri https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-windows-amd64.exe -OutFile gpuctl.exe
          
          # Windows ARM64Êû∂ÊûÑ
          Invoke-WebRequest -Uri https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/gpuctl-windows-arm64.exe -OutFile gpuctl.exe
          
          # Â∞Ügpuctl.exeÊ∑ªÂä†Âà∞Á≥ªÁªüPATH‰∏≠ÔºåÁÑ∂ÂêéËøêË°å
          gpuctl.exe --help
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}